<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“š Book Inventory with Login & Backup</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background: #f5f7fa; 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  padding: 20px; 
  min-height: 100vh; 
}
h1 { color: #333; margin-bottom: 20px; font-size: 2rem; }
.input-container, .category-tools { 
  width: 100%; max-width: 600px; background: #fff; padding: 20px; border-radius: 12px; 
  box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; 
}
input, select, button { padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
input:focus, select:focus { outline: none; border-color: #4CAF50; }
button { cursor: pointer; background-color: #4CAF50; color: #fff; border: none; transition: 0.3s; border-radius: 8px; }
button:hover { background-color: #45a049; }
button.secondary { background-color: #f44336; } button.secondary:hover { background-color: #e53935; }
button.info { background-color: #2196F3; } button.info:hover { background-color: #1976D2; }
button.warning { background-color: #FF9800; } button.warning:hover { background-color: #F57C00; }
.delete-btn { background-color: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
.delete-btn:hover { background-color: #e53935; }
#totalBooks { margin-top: 15px; font-weight: bold; font-size: 1.2rem; color: #333; text-align: center; }

/* Responsive custom file input */
.file-input-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.file-input-wrapper label {
  background: #FF9800;
  color: #fff;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
  white-space: nowrap;
}
.file-input-wrapper label:hover {
  background: #F57C00;
}
#fileName {
  font-size: 0.9rem;
  color: #555;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
#importFile { display: none; }

/* Table responsiveness */
.table-container {
  width: 100%;
  max-width: 700px;
  overflow-x: auto;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  background: #fff;
}
table { width: 100%; border-collapse: collapse; }
th, td { 
  padding: 14px 12px; 
  text-align: left; 
  border-bottom: 1px solid #eee; 
  white-space: nowrap; 
}
th { background-color: #f4f6f8; font-weight: 600; }

/* Responsive layout improvements */
@media(max-width: 650px){
  .input-container, .category-tools, .table-container { width: 95%; }
  th, td { font-size: 0.9rem; padding: 10px; }
  input, select, button { font-size: 0.9rem; padding: 10px; }
  #fileName { max-width: 100%; }
  .restore-controls {
    flex-direction: column;
    align-items: stretch;
  }
  .restore-controls select,
  .restore-controls button {
    width: 100%;
  }
}
</style>
</head>
<body>
<h1>ðŸ“š Book Inventory with Backup</h1>

<!-- Login Form -->
<div id="authContainer" style="max-width:400px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); margin-bottom:20px;">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
    <button id="loginBtn">Login</button>
  </div>
  <button id="logoutBtn" class="secondary" style="margin-top:10px; display:none;">Logout</button>
</div>

<!-- Inventory App -->
<div id="appContainer" style="display:none;">
  <div class="input-container">
    <input type="text" id="bookName" placeholder="Enter book name">
    <input type="number" id="bookAmount" placeholder="Enter amount">
    <select id="bookCategory">
      <option value="">Select Category</option>
      <option>1st SEM</option>
      <option>3rd SEM</option>
      <option>5th SEM</option>
      <option>7th SEM</option>
      <option>Other</option>
    </select>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button id="addBtn">Add Book</button>
      <button id="clearAllBtn" class="secondary">Clear All Books</button>
      <button id="exportBtn" class="info">Export CSV</button>
      <div class="file-input-wrapper">
        <label for="importFile">Choose CSV</label>
        <span id="fileName">No file chosen</span>
        <input type="file" id="importFile" accept=".csv">
      </div>
      <button id="importBtn" class="warning">Import CSV</button>
      <button id="backupBtn" class="info">Backup Now</button>
    </div>
    <div class="restore-controls" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <select id="restoreSelect"></select>
      <button id="restoreBtn" class="warning">Restore Backup</button>
      <button id="deleteBackupBtn" class="secondary">Delete Backup</button>
    </div>
  </div>

  <div class="category-tools">
    <label><b>Filter:</b></label>
    <select id="filterCategory"><option value="All">All</option></select>
    <label><b>Search:</b></label>
    <input type="text" id="searchBox" placeholder="Search...">
  </div>

  <div class="table-container">
    <table id="bookTable">
      <thead>
        <tr><th>Name</th><th>Amount</th><th>Category</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="totalBooks">Total Books: 0</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove, update, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqOE9GsfwOedcwbVIR_fmEMRERcm8ikF4",
  authDomain: "book-inventory-bd5ba.firebaseapp.com",
  databaseURL: "https://book-inventory-bd5ba-default-rtdb.firebaseio.com",
  projectId: "book-inventory-bd5ba",
  storageBucket: "book-inventory-bd5ba.firebasestorage.app",
  messagingSenderId: "778702930923",
  appId: "1:778702930923:web:34a672ffda2eaa764f4fae",
  measurementId: "G-MW8W0RSYY2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const booksRef = ref(db, 'books');
const backupsRef = ref(db, 'backups');
let latestSnapshot = null;
let logoutTimer = null;

// --- AUTH LOGIC ---
const authContainer = document.getElementById("authContainer");
const appContainer = document.getElementById("appContainer");
const logoutBtn = document.getElementById("logoutBtn");

document.getElementById("loginBtn").addEventListener("click", ()=>{
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  signInWithEmailAndPassword(auth, email, password).catch(err=>alert(err.message));
});

logoutBtn.addEventListener("click", ()=> signOut(auth));

onAuthStateChanged(auth, user=>{
  if(user){
    authContainer.style.display="none";
    appContainer.style.display="block";
    logoutBtn.style.display="block";

    // Auto logout after 2 hours (7200000 ms)
    if(logoutTimer) clearTimeout(logoutTimer);
    logoutTimer = setTimeout(()=>{
      alert("â° Session expired. Please log in again.");
      signOut(auth);
    }, 7200000);

  } else {
    authContainer.style.display="block";
    appContainer.style.display="none";
    logoutBtn.style.display="none";

    if(logoutTimer) clearTimeout(logoutTimer);
  }
});

// --- Inventory System (unchanged) ---
document.getElementById("importFile").addEventListener("change", e=>{
  const fileName = e.target.files.length ? e.target.files[0].name : "No file chosen";
  document.getElementById("fileName").textContent = fileName;
});

document.getElementById('addBtn').addEventListener('click', ()=>{
  const name = document.getElementById('bookName').value.trim();
  const amount = document.getElementById('bookAmount').value.trim();
  const category = document.getElementById('bookCategory').value.trim();
  if(!name || !amount || !category){ alert("Fill all fields"); return; }
  const newBookRef = push(booksRef);
  set(newBookRef, {name, amount:Number(amount), category});
  document.getElementById('bookName').value='';
  document.getElementById('bookAmount').value='';
  document.getElementById('bookCategory').value='';
});

document.getElementById('clearAllBtn').addEventListener('click', ()=>{ if(confirm("Delete all books?")) remove(booksRef); });

document.getElementById('exportBtn').addEventListener('click', ()=>{
  if(!latestSnapshot) return;
  let csv = "Book Name,Amount,Category\n";
  latestSnapshot.forEach(child=>{ const b = child.val(); csv += `"${b.name}",${b.amount},"${b.category}"\n`; });
  const blob = new Blob([csv], {type:"text/csv"});
  const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'book_list.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
});

document.getElementById('importBtn').addEventListener('click', ()=>{
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files.length){ alert("Choose CSV first."); return; }
  const file = fileInput.files[0]; const reader = new FileReader();
  reader.onload = function(e){
    const lines = e.target.result.split("\n").map(l=>l.trim()).filter(l=>l);
    for(let i=1;i<lines.length;i++){
      const [name, amount, category] = lines[i].split(",").map(v=>v.replace(/(^"|"$)/g,"").trim());
      if(name && amount && category){ const newBookRef = push(booksRef); set(newBookRef,{name, amount:Number(amount), category}); }
    }
    fileInput.value='';
    document.getElementById("fileName").textContent = "No file chosen";
  }; reader.readAsText(file);
});

document.getElementById('backupBtn').addEventListener('click', async ()=>{
  if(!latestSnapshot) { alert("No data to backup"); return; }
  const timestamp = new Date().toISOString();
  let backupData = {};
  latestSnapshot.forEach(child=>{ backupData[child.key]=child.val(); });
  await push(backupsRef, {timestamp, books: backupData});
  alert("Backup completed!");
  loadBackups();
});

document.getElementById('restoreBtn').addEventListener('click', async ()=>{
  const backupKey = document.getElementById('restoreSelect').value;
  if(!backupKey){ alert("Select backup first"); return; }
  const backupSnap = await get(child(backupsRef, backupKey));
  if(!backupSnap.exists()){ alert("Backup not found"); return; }
  const booksData = backupSnap.val().books;
  remove(booksRef);
  Object.values(booksData).forEach(b=>{
    const newBookRef = push(booksRef);
    set(newBookRef, b);
  });
  alert("Restore completed!");
});

document.getElementById('deleteBackupBtn').addEventListener('click', async () => {
  const backupKey = document.getElementById('restoreSelect').value;
  if(!backupKey){ alert("Select backup first"); return; }
  if(!confirm("Are you sure you want to delete this backup?")) return;
  try{
    await remove(child(backupsRef, backupKey));
    alert("Backup deleted!");
    loadBackups();
  }catch(err){
    console.error(err);
    alert("Failed to delete backup.");
  }
});

async function loadBackups(){
  const snap = await get(backupsRef);
  const restoreSelect = document.getElementById('restoreSelect');
  restoreSelect.innerHTML = '<option value="">Select Backup</option>';
  if(snap.exists()){
    Object.entries(snap.val()).forEach(([key,val])=>{
      const option = document.createElement('option');
      option.value=key; option.text=`${val.timestamp}`;
      restoreSelect.appendChild(option);
    });
  }
}

window.updateBook = function(id, field, value){ if(field==='amount') value = Number(value); update(ref(db, 'books/'+id), {[field]:value}); }
window.deleteBook = function(id){ remove(ref(db, 'books/'+id)); }

onValue(booksRef, snapshot=>{ latestSnapshot=snapshot; renderTable(); loadBackups(); });

function renderTable(){
  if(!latestSnapshot) return;
  const tbody = document.querySelector("#bookTable tbody"); tbody.innerHTML='';
  const filter = document.getElementById('filterCategory').value;
  const search = document.getElementById('searchBox').value.toLowerCase();
  let total=0; const categories=new Set();
  latestSnapshot.forEach(child=>{
    const b=child.val(), id=child.key; categories.add(b.category);
    if((filter==='All'||b.category===filter)&&b.name.toLowerCase().includes(search)){
      total+=Number(b.amount);
      const row=document.createElement('tr');
      row.innerHTML=`<td contenteditable="true" onblur="updateBook('${id}','name',this.innerText)">${b.name}</td>
                     <td contenteditable="true" onblur="updateBook('${id}','amount',this.innerText)">${b.amount}</td>
                     <td contenteditable="true" onblur="updateBook('${id}','category',this.innerText)">${b.category}</td>
                     <td><button class="delete-btn" onclick="deleteBook('${id}')">Delete</button></td>`;
      tbody.appendChild(row);
    }
  });
  const filterSelect=document.getElementById('filterCategory'); filterSelect.innerHTML='<option value="All">All</option>';
  categories.forEach(c=>filterSelect.innerHTML+=`<option value="${c}">${c}</option>`);
  document.getElementById('totalBooks').innerText=`Total Books: ${total}`;
}

document.getElementById('searchBox').addEventListener('input', renderTable);
document.getElementById('filterCategory').addEventListener('change', renderTable);
</script>
</body>
</html>
