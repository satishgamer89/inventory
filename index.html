<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ“š Book Inventory</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f4f8; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; }
h1 { color:#333; }
.input-container, .category-tools { width:100%; max-width:500px; display:flex; flex-direction:column; margin-bottom:20px; }
input, select, button { margin:5px 0; padding:10px; font-size:16px; border-radius:5px; border:1px solid #ccc; }
button { cursor:pointer; background-color:#4CAF50; color:white; border:none; transition:0.3s; }
button:hover { background-color:#45a049; }
#clearAllBtn { background-color:#f44336; } #clearAllBtn:hover { background-color:#e53935; }
#exportBtn { background-color:#2196F3; } #exportBtn:hover { background-color:#1976D2; }
#importBtn { background-color:#FF9800; } #importBtn:hover { background-color:#F57C00; }
table { width:100%; max-width:750px; border-collapse:collapse; margin-top:20px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
th, td { padding:12px; text-align:left; border-bottom:1px solid #ddd; word-break:break-word; }
th { background-color:#f7f7f7; }
.delete-btn { padding:6px 12px; cursor:pointer; background:#f44336; color:white; border:none; border-radius:4px; }
.delete-btn:hover { background:#e53935; }
#totalBooks { margin-top:15px; font-weight:bold; font-size:18px; color:#333; text-align:center; }
@media (max-width:600px){ table, th, td { font-size:14px; } input, select, button { font-size:14px; padding:8px; } }
</style>
</head>
<body>
<h1>ðŸ“š Book Inventory</h1>

<div class="input-container">
<input type="text" id="bookName" placeholder="Enter book name">
<input type="number" id="bookAmount" placeholder="Enter amount">
<select id="bookCategory">
<option value="">Select Category</option>
<option>1st SEM</option>
<option>3rd SEM</option>
<option>5th SEM</option>
<option>7th SEM</option>
<option>Other</option>
</select>
<button id="addBtn">Add Book</button>
<button id="clearAllBtn">Clear All Books</button>
<button id="exportBtn">Export CSV</button>
<input type="file" id="importFile" accept=".csv">
<button id="importBtn">Import CSV</button>
</div>

<div class="category-tools">
<label><b>Filter:</b></label>
<select id="filterCategory"><option value="All">All</option></select>

<label><b>Search:</b></label>
<input type="text" id="searchBox" placeholder="Search..." >

<label><b>Add Category:</b></label>
<input type="text" id="newCategory" placeholder="New category name">
<button id="addCategoryBtn">Add Category</button>

<label><b>Rename Category:</b></label>
<select id="renameFrom"></select>
<input type="text" id="renameTo" placeholder="New category name">
<button id="renameBtn">Rename</button>
</div>

<table id="bookTable">
<thead><tr><th>Name</th><th>Amount</th><th>Category</th><th>Actions</th></tr></thead>
<tbody></tbody>
</table>

<div id="totalBooks">Total Books: 0</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyDqOE9GsfwOedcwbVIR_fmEMRERcm8ikF4",
    authDomain: "book-inventory-bd5ba.firebaseapp.com",
    databaseURL: "https://book-inventory-bd5ba-default-rtdb.firebaseio.com",
    projectId: "book-inventory-bd5ba",
    storageBucket: "book-inventory-bd5ba.firebasestorage.app",
    messagingSenderId: "778702930923",
    appId: "1:778702930923:web:34a672ffda2eaa764f4fae",
    measurementId: "G-MW8W0RSYY2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const booksRef = ref(db, 'books');
let latestSnapshot = null;

// Add book
document.getElementById('addBtn').addEventListener('click', ()=>{
  const name = document.getElementById('bookName').value.trim();
  const amount = document.getElementById('bookAmount').value.trim();
  const category = document.getElementById('bookCategory').value.trim();
  if(!name || !amount || !category){ alert("Fill all fields"); return; }
  const newBookRef = push(booksRef);
  set(newBookRef, {name, amount:Number(amount), category});
  document.getElementById('bookName').value='';
  document.getElementById('bookAmount').value='';
  document.getElementById('bookCategory').value='';
});

// Clear all books
document.getElementById('clearAllBtn').addEventListener('click', ()=>{
  if(confirm("Delete all books?")) remove(booksRef);
});

// Rename category
document.getElementById('renameBtn').addEventListener('click', ()=>{
  const from = document.getElementById('renameFrom').value;
  const to = document.getElementById('renameTo').value.trim();
  if(!from || !to){ alert("Select and enter new category"); return; }
  if(!latestSnapshot) return;
  latestSnapshot.forEach(child => {
    const book = child.val();
    if(book.category === from) update(ref(db, 'books/' + child.key), {category: to});
  });
  document.getElementById('renameTo').value='';
});

// Add new category
document.getElementById('addCategoryBtn').addEventListener('click', ()=>{
  const newCat = document.getElementById('newCategory').value.trim();
  if(!newCat){ alert("Enter category name"); return; }

  const bookCatSelect = document.getElementById('bookCategory');
  if(!Array.from(bookCatSelect.options).some(opt => opt.value === newCat)){
    const opt = document.createElement('option'); opt.value=newCat; opt.textContent=newCat;
    bookCatSelect.appendChild(opt);
  }

  const filterSelect = document.getElementById('filterCategory');
  if(!Array.from(filterSelect.options).some(opt => opt.value === newCat)){
    const opt = document.createElement('option'); opt.value=newCat; opt.textContent=newCat;
    filterSelect.appendChild(opt);
  }

  const renameSelect = document.getElementById('renameFrom');
  if(!Array.from(renameSelect.options).some(opt => opt.value === newCat)){
    const opt = document.createElement('option'); opt.value=newCat; opt.textContent=newCat;
    renameSelect.appendChild(opt);
  }

  document.getElementById('newCategory').value='';
});

// Export CSV
document.getElementById('exportBtn').addEventListener('click', ()=>{
  if(!latestSnapshot) return;
  let csv = "Book Name,Amount,Category\n";
  latestSnapshot.forEach(child=>{
    const b = child.val();
    csv += `"${b.name}",${b.amount},"${b.category}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'book_list.csv';
  document.body.appendChild(link); link.click(); document.body.removeChild(link);
});

// Import CSV
document.getElementById('importBtn').addEventListener('click', ()=>{
  const fileInput = document.getElementById('importFile');
  if(!fileInput.files.length){ alert("Choose CSV first."); return; }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    const lines = e.target.result.split("\n").map(l=>l.trim()).filter(l=>l);
    for(let i=1;i<lines.length;i++){
      const [name, amount, category] = lines[i].split(",").map(v=>v.replace(/(^"|"$)/g,"").trim());
      if(name && amount && category) push(booksRef).then(()=> set(ref(db, 'books/' + push(booksRef).key), {name, amount:Number(amount), category}));
    }
    fileInput.value='';
  }
  reader.readAsText(file);
});

// Update/Delete
window.updateBook = function(id, field, value){
  if(field==='amount') value = Number(value);
  update(ref(db, 'books/' + id), {[field]: value});
}
window.deleteBook = function(id){ remove(ref(db, 'books/' + id)); }

// Listen to DB and store snapshot
onValue(booksRef, snapshot=>{
  latestSnapshot = snapshot;
  renderTable();
});

// Render table function
function renderTable(){
  if(!latestSnapshot) return;
  const tbody = document.querySelector("#bookTable tbody");
  tbody.innerHTML='';
  const filter = document.getElementById('filterCategory').value;
  const search = document.getElementById('searchBox').value.toLowerCase();
  let total=0;
  const categories = new Set();

  latestSnapshot.forEach(child=>{
    const b = child.val(); const id = child.key;
    categories.add(b.category);
    if((filter==='All' || b.category===filter) && b.name.toLowerCase().includes(search)){
      total += Number(b.amount);
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true" onblur="updateBook('${id}','name',this.innerText)">${b.name}</td>
        <td contenteditable="true" onblur="updateBook('${id}','amount',this.innerText)">${b.amount}</td>
        <td contenteditable="true" onblur="updateBook('${id}','category',this.innerText)">${b.category}</td>
        <td><button class="delete-btn" onclick="deleteBook('${id}')">Delete</button></td>
      `;
      tbody.appendChild(row);
    }
  });

  const filterSelect = document.getElementById('filterCategory');
  const renameFromSelect = document.getElementById('renameFrom');
  filterSelect.innerHTML=`<option value="All">All</option>`;
  renameFromSelect.innerHTML='';
  categories.forEach(c=>{
    filterSelect.innerHTML += `<option value="${c}">${c}</option>`;
    renameFromSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });

  document.getElementById('totalBooks').innerText = `Total Books: ${total}`;
}

// Search/filter triggers
document.getElementById('searchBox').addEventListener('input', renderTable);
document.getElementById('filterCategory').addEventListener('change', renderTable);

</script>
</body>
</html>
